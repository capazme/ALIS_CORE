# ============================================================================
# VisuaLex Platform - Docker Compose Configuration
# ============================================================================
# Usage:
#   Development:  docker compose up
#   Production:   docker compose -f docker-compose.yml -f docker-compose.prod.yml up
#   With MERL-T:  MERLT_ENABLED=true docker compose up
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Frontend - React/Vite served via Nginx
  # --------------------------------------------------------------------------
  frontend:
    build:
      context: ..
      dockerfile: visualex-platform/frontend/Dockerfile
      args:
        # Vite build-time variables (baked into the bundle)
        VITE_API_URL: "/api"
        VITE_PYTHON_API_URL: "/api"
        VITE_MERLT_ENABLED: "${VITE_MERLT_ENABLED:-false}"
    ports:
      - "5173:80"
    depends_on:
      - backend
      - python-api
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Backend - Express/TypeScript/Prisma
  # --------------------------------------------------------------------------
  backend:
    build:
      context: ..
      dockerfile: visualex-platform/backend/Dockerfile
    ports:
      - "3001:3001"
    env_file:
      - .env
      - .env.docker
    environment:
      # Explicit overrides for Docker networking
      - DATABASE_URL=postgresql://${POSTGRES_USER:-visualex}:${POSTGRES_PASSWORD:-visualex}@postgres:5432/${POSTGRES_DB:-visualex}
      - MERLT_API_URL=${MERLT_API_URL:-http://merlt-api:8000}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Python API - VisuaLex Scrapers (Normattiva, Brocardi, EUR-Lex)
  # --------------------------------------------------------------------------
  python-api:
    build:
      context: ../visualex-api
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # PostgreSQL Database
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-visualex}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-visualex}
      - POSTGRES_DB=${POSTGRES_DB:-visualex}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-visualex} -d ${POSTGRES_DB:-visualex}"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data:
    name: visualex_postgres_data
