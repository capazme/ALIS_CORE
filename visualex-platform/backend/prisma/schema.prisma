// VisuaLex Platform Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

// Profile types for ALIS user experience levels
enum ProfileType {
  quick_consultation    // ‚ö° Consultazione Rapida
  assisted_research     // üìñ Ricerca Assistita
  expert_analysis       // üîç Analisi Esperta
  active_contributor    // üéì Contributore Attivo (requires authority ‚â• 0.5)
}

// Consent levels for RLCF data participation (GDPR Art. 6)
enum ConsentLevel {
  basic      // No data collected beyond session
  learning   // Anonymized queries + feedback for RLCF training
  research   // Aggregated data available for academic analysis
}

model User {
  id             String       @id @default(uuid())
  email          String       @unique
  username       String       @unique
  password       String
  isActive       Boolean      @default(true) @map("is_active")
  isVerified     Boolean      @default(false) @map("is_verified")
  isAdmin        Boolean      @default(false) @map("is_admin")
  isMerltEnabled Boolean      @default(false) @map("is_merlt_enabled")
  profileType    ProfileType  @default(assisted_research) @map("profile_type")
  authorityScore Float        @default(0.0) @map("authority_score")
  loginCount     Int          @default(0) @map("login_count")
  lastLoginAt    DateTime?    @map("last_login_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // GDPR deletion (Art. 17)
  deletionRequestedAt DateTime? @map("deletion_requested_at")
  deletionReason      String?   @map("deletion_reason")

  // Relationships
  folders       Folder[]
  bookmarks     Bookmark[]
  annotations   Annotation[]
  highlights    Highlight[]
  dossiers      Dossier[]
  feedbacks     Feedback[]
  searchHistory SearchHistory[]
  features      UserFeature[]
  preferences   UserPreferences?

  // Shared Environments (Bulletin Board)
  sharedEnvironments       SharedEnvironment[]
  sharedEnvironmentLikes   SharedEnvironmentLike[]
  sharedEnvironmentReports SharedEnvironmentReport[]
  suggestionsMade          EnvironmentSuggestion[]   @relation("SuggestionsMade")

  // Tokens
  refreshTokens RefreshToken[]

  // Consent
  consent UserConsent?

  // Authority
  authority UserAuthority?

  @@map("users")
}

// User preferences for UI customization
model UserPreferences {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  theme                String   @default("system") // light, dark, system
  language             String   @default("it") // it, en
  notificationsEnabled Boolean  @default(true) @map("notifications_enabled")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ============================================
// CONSENT MANAGEMENT (GDPR Art. 6, Art. 7)
// ============================================

// User consent record for RLCF participation
model UserConsent {
  id           String       @id @default(uuid())
  userId       String       @unique @map("user_id")
  consentLevel ConsentLevel @default(basic) @map("consent_level")
  grantedAt    DateTime     @default(now()) @map("granted_at")
  ipHash       String?      @map("ip_hash") // SHA-256 hashed IP for privacy

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_consents")
}

// Append-only audit log for consent changes (7-year retention per NFR-R5)
// No UPDATE/DELETE permissions - immutable record
model ConsentAuditLog {
  id            String        @id @default(uuid())
  userId        String        @map("user_id") // No FK - survives user deletion
  previousLevel ConsentLevel? @map("previous_level")
  newLevel      ConsentLevel  @map("new_level")
  ipHash        String?       @map("ip_hash")
  userAgent     String?       @map("user_agent")
  changedAt     DateTime      @default(now()) @map("changed_at")

  // Note: No foreign key to User - audit log must survive user deletion
  // This table should have restricted permissions (INSERT only)

  @@index([userId])
  @@index([changedAt])
  @@map("consent_audit_log")
}

// ============================================
// AUTHORITY SCORE (RLCF Influence)
// ============================================

// User authority score breakdown for RLCF participation
// Formula: A_u(t) = 0.3¬∑B_u + 0.5¬∑T_u(t) + 0.2¬∑P_u(t)
model UserAuthority {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  baselineScore     Float    @default(0.1) @map("baseline_score")      // B: From profile/credentials (0.1-0.5)
  trackRecordScore  Float    @default(0.0) @map("track_record_score")  // T: Historical feedback accuracy
  recentPerformance Float    @default(0.0) @map("recent_performance")  // P: Last N feedback quality
  computedScore     Float    @default(0.03) @map("computed_score")     // Weighted sum
  feedbackCount     Int      @default(0) @map("feedback_count")        // Total feedbacks given
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_authority")
}

// ============================================
// AUTHENTICATION
// ============================================

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// FOLDER HIERARCHY
// ============================================

model Folder {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String?
  icon        String?
  position    Int      @default(0)
  parentId    String?  @map("parent_id")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Folder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[]   @relation("FolderHierarchy")
  bookmarks Bookmark[]

  @@index([userId])
  @@index([parentId])
  @@map("folders")
}

// ============================================
// BOOKMARKS (Saved Articles)
// ============================================

model Bookmark {
  id         String   @id @default(uuid())
  normaKey   String   @map("norma_key") // e.g., "Art. 1414 c.c."
  normaData  Json     @map("norma_data") // Full article data from VisualEx API
  title      String? // Optional custom title
  notes      String? // User notes
  tags       String[] // Array of tags
  folderId   String?  @map("folder_id")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relationships
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder      Folder?      @relation(fields: [folderId], references: [id], onDelete: SetNull)
  annotations Annotation[]
  highlights  Highlight[]

  @@index([userId])
  @@index([folderId])
  @@index([normaKey])
  @@map("bookmarks")
}

// ============================================
// ANNOTATIONS (Notes on Articles)
// ============================================

enum AnnotationType {
  note
  question
  important
  follow_up
  summary
}

model Annotation {
  id             String         @id @default(uuid())
  normaKey       String         @map("norma_key")
  content        String
  annotationType AnnotationType @default(note) @map("annotation_type")
  textContext    String?        @map("text_context") // Surrounding text for context
  position       Int?           // Position in article
  bookmarkId     String?        @map("bookmark_id")
  userId         String         @map("user_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relationships
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookmark Bookmark? @relation(fields: [bookmarkId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookmarkId])
  @@index([normaKey])
  @@map("annotations")
}

// ============================================
// HIGHLIGHTS (Text Highlighting)
// ============================================

model Highlight {
  id          String   @id @default(uuid())
  normaKey    String   @map("norma_key")
  text        String // Highlighted text
  color       String   @default("yellow") // yellow, green, red, blue
  startOffset Int      @map("start_offset")
  endOffset   Int      @map("end_offset")
  note        String? // Optional note
  bookmarkId  String?  @map("bookmark_id")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relationships
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookmark Bookmark? @relation(fields: [bookmarkId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookmarkId])
  @@index([normaKey])
  @@map("highlights")
}

// ============================================
// DOSSIERS (Work Folders / Projects)
// ============================================

model Dossier {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String?
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  items DossierItem[]

  @@index([userId])
  @@map("dossiers")
}

enum DossierItemType {
  norm
  note
  section
}

model DossierItem {
  id         String          @id @default(uuid())
  dossierId  String          @map("dossier_id")
  itemType   DossierItemType @map("item_type")
  title      String
  content    Json? // Flexible content (norm data, note text, etc.)
  position   Int             @default(0)
  createdAt  DateTime        @default(now()) @map("created_at")

  // Relationships
  dossier Dossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId])
  @@map("dossier_items")
}

// ============================================
// FEEDBACK (Bug Reports & Suggestions)
// ============================================

enum FeedbackType {
  bug
  suggestion
  other
}

enum FeedbackStatus {
  new
  read
  resolved
  dismissed
}

model Feedback {
  id        String         @id @default(uuid())
  type      FeedbackType
  message   String
  status    FeedbackStatus @default(new)
  userId    String         @map("user_id")
  createdAt DateTime       @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("feedbacks")
}

// ============================================
// SEARCH HISTORY
// ============================================

model SearchHistory {
  id        String   @id @default(uuid())
  actType   String   @map("act_type")
  actNumber String?  @map("act_number")
  article   String?
  date      String?
  version   String?  @default("vigente")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("search_history")
}

// ============================================
// SHARED ENVIRONMENTS (Bulletin Board)
// ============================================

enum EnvironmentCategory {
  compliance
  civil
  penal
  administrative
  eu
  other
}

enum ReportReason {
  spam
  inappropriate
  copyright
  other
}

enum ReportStatus {
  pending
  reviewed
  dismissed
}

model SharedEnvironment {
  id          String              @id @default(uuid())
  title       String
  description String?

  // Environment content (dossiers, quickNorms, annotations, highlights)
  content Json

  // Sharing options
  includeNotes      Boolean @default(true) @map("include_notes")
  includeHighlights Boolean @default(true) @map("include_highlights")

  // Categorization
  category EnvironmentCategory
  tags     String[]

  // Metrics
  viewCount     Int @default(0) @map("view_count")
  downloadCount Int @default(0) @map("download_count")

  // Versioning
  currentVersion Int      @default(1) @map("current_version")
  isActive       Boolean  @default(true) @map("is_active")
  replacedById   String?  @map("replaced_by_id")

  // Ownership
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  user        User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes       SharedEnvironmentLike[]
  reports     SharedEnvironmentReport[]
  versions    SharedEnvironmentVersion[]
  suggestions EnvironmentSuggestion[]

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@index([isActive])
  @@map("shared_environments")
}

model SharedEnvironmentLike {
  id        String   @id @default(uuid())
  envId     String   @map("env_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  environment SharedEnvironment @relation(fields: [envId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([envId, userId])
  @@index([envId])
  @@index([userId])
  @@map("shared_environment_likes")
}

model SharedEnvironmentReport {
  id        String       @id @default(uuid())
  envId     String       @map("env_id")
  userId    String       @map("user_id")
  reason    ReportReason
  details   String?
  status    ReportStatus @default(pending)
  createdAt DateTime     @default(now()) @map("created_at")

  // Relationships
  environment SharedEnvironment @relation(fields: [envId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([envId, userId])
  @@index([envId])
  @@index([status])
  @@map("shared_environment_reports")
}

// ============================================
// ENVIRONMENT SUGGESTIONS & VERSIONING
// ============================================

enum SuggestionStatus {
  pending
  approved
  rejected
}

model EnvironmentSuggestion {
  id                  String            @id @default(uuid())
  sharedEnvironmentId String            @map("shared_environment_id")
  suggesterId         String            @map("suggester_id")

  // Suggested content (only dossiers, quickNorms, customAliases)
  content Json

  // Optional message from suggester
  message String?

  // Review status
  status     SuggestionStatus @default(pending)
  reviewedAt DateTime?        @map("reviewed_at")
  reviewNote String?          @map("review_note")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  sharedEnvironment SharedEnvironment         @relation(fields: [sharedEnvironmentId], references: [id], onDelete: Cascade)
  suggester         User                      @relation("SuggestionsMade", fields: [suggesterId], references: [id], onDelete: Cascade)
  version           SharedEnvironmentVersion?

  @@index([sharedEnvironmentId])
  @@index([suggesterId])
  @@index([status])
  @@map("environment_suggestions")
}

model SharedEnvironmentVersion {
  id                  String @id @default(uuid())
  sharedEnvironmentId String @map("shared_environment_id")

  // Version info
  version   Int     // Sequential version number (1, 2, 3...)
  content   Json    // Snapshot of environment content at this version
  changelog String? // Description of changes

  // Link to suggestion that created this version (if applicable)
  suggestionId String?               @unique @map("suggestion_id")
  suggestion   EnvironmentSuggestion? @relation(fields: [suggestionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  sharedEnvironment SharedEnvironment @relation(fields: [sharedEnvironmentId], references: [id], onDelete: Cascade)

  @@unique([sharedEnvironmentId, version])
  @@index([sharedEnvironmentId])
  @@map("shared_environment_versions")
}

// ============================================
// FEATURE FLAGS (Plugin System)
// ============================================

model UserFeature {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  featureId    String    @map("feature_id")
  enabled      Boolean   @default(false)
  consentGiven Boolean   @default(false) @map("consent_given")
  consentDate  DateTime? @map("consent_date")
  enabledBy    String?   @map("enabled_by") // Admin user ID who enabled this
  enabledAt    DateTime? @map("enabled_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureId])
  @@index([userId])
  @@index([featureId])
  @@map("user_features")
}
